#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Check for secrets in staged files
echo "ğŸ“ Scanning for secrets..."

# Run gitleaks on staged files only
if command -v gitleaks &> /dev/null; then
  gitleaks protect --staged --config=.gitleaks.toml --verbose --redact
  if [ $? -ne 0 ]; then
    echo "âŒ GitLeaks detected secrets in your commit!"
    echo "Please remove sensitive data before committing."
    exit 1
  fi
  echo "âœ… No secrets detected"
else
  echo "âš ï¸  GitLeaks not installed. Install with: brew install gitleaks"
  echo "Falling back to simple pattern check..."
  
  # Simple grep fallback
  if git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -l "AIza\|sk_test_\|sk_live_\|rzp_live_\|eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9" 2>/dev/null; then
    echo "âŒ Potential secrets found in staged files!"
    echo "Please review and remove sensitive data."
    exit 1
  fi
  echo "âœ… Basic check passed"
fi

# Check TypeScript types
echo "ğŸ”§ Type checking..."
npx tsc --noEmit || {
  echo "âŒ TypeScript errors found!"
  exit 1
}
echo "âœ… Type check passed"

# Run linter
echo "ğŸ§¹ Linting..."
npm run lint || {
  echo "âŒ Linting errors found!"
  exit 1
}
echo "âœ… Lint passed"

echo "âœ… All pre-commit checks passed!"
